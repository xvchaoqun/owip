<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="persistence.cadre.common.ICadreMapper">

    <sql id="statCadreSearchSql">
        1=1
        <if test="searchBean.cadreId!=null">
            and c.id=#{searchBean.cadreId}
        </if>
        <if test="searchBean.cadreStatus!=null">
            and c.status=#{searchBean.cadreStatus}
        </if>
        <if test="searchBean.unitTypeId!=null">
            and c.unit_type_id=#{searchBean.unitTypeId}
        </if>
        <if test="searchBean.notUnitTypeId!=null">
            and c.unit_type_id!=#{searchBean.notUnitTypeId}
        </if>
        <if test="searchBean.hasTalentTitle!=null">
            and c.talent_title is not null
        </if>
    </sql>
    <!--1、查找干部的（境外）学习经历 -->
    <select id="selectCadreEduList" resultMap="persistence.cadre.CadreEduMapper.IBaseResultMap" parameterType="map">
        select ce.* from cadre_edu ce , cadre c where
        <include refid="statCadreSearchSql" />
        and ce.cadre_id=c.id and ce.school_type =#{schoolType}
    </select>
    <select id="countCadreEduList" parameterType="map" resultType="java.lang.Integer">
        select count(distinct ce.id) from cadre_edu ce , cadre c where
        <include refid="statCadreSearchSql" />
        and ce.cadre_id=c.id and ce.school_type =#{schoolType}
    </select>
    <!--2、查找干部的工作经历 3、查找（机关）干部的（院系）工作经历 4、查找（院系）干部的（机关）工作经历-->
    <select id="selectCadreWorkList" resultMap="persistence.cadre.CadreWorkMapper.IBaseResultMap" parameterType="map">
        select cw.* from cadre_work cw , cadre_view c where <include refid="statCadreSearchSql" />
        and cw.cadre_id=c.id and cw.work_type =#{workType}
    </select>
    <select id="countCadreWorkList" parameterType="map" resultType="java.lang.Integer">
        select count(distinct cw.id) from cadre_work cw , cadre_view c where <include refid="statCadreSearchSql" />
        and cw.cadre_id=c.id and cw.work_type =#{workType}
    </select>
    <!--5、有校外挂职经历的干部-->
    <select id="selectCrpRecordList" resultMap="persistence.crp.CrpRecordMapper.BaseResultMap" parameterType="map">
        select cr.* from crp_record cr , cadre c where <include refid="statCadreSearchSql" />
        and cr.user_id=c.user_id and cr.type =#{type}
    </select>
    <select id="countCrpRecordList" parameterType="map" resultType="java.lang.Integer">
        select count(distinct cr.id) from crp_record cr , cadre c where <include refid="statCadreSearchSql" />
        and cr.user_id=c.user_id and cr.type =#{type}
    </select>

    <!--6、具有人才/荣誉称号的干部-->
    <select id="selectTalentCadreList" resultType="persistence.cadre.common.ICarde" parameterType="map">
        select c.id from cadre_view c where <include refid="statCadreSearchSql" />
    </select>
    <select id="countTalentCadreList" parameterType="map" resultType="java.lang.Integer">
        select count(distinct c.id) from cadre_view c where <include refid="statCadreSearchSql" />
    </select>

    <sql id="cadreSearchSql">
        <if test="search != null">
            and (u.username like #{search} or u.realname like #{search} or u.code like #{search})
        </if>
        <if test="isCommitteeMember != null">
            and c.is_committee_member = #{isCommitteeMember}
        </if>
        <if test="cadreStatusList!=null and cadreStatusList.size>0">
            and c.status in
            <foreach collection="cadreStatusList" item="st"
                     index="index" open="(" close=")" separator=",">
                #{st}
            </foreach>
        </if>
     </sql>
    <select id="selectCadreList" resultMap="persistence.cadre.CadreMapper.BaseResultMap" parameterType="map">
        select c.* from cadre c, sys_user_view u where c.user_id= u.id
        <include refid="cadreSearchSql" />
        order by c.sort_order desc
    </select>
    <select id="countCadreList" parameterType="map" resultType="java.lang.Integer">
        select count(c.id) from cadre c, sys_user_view u where c.user_id= u.id
        <include refid="cadreSearchSql" />
    </select>


    <sql id="userSearchSql">
        select * from sys_user_view
        <if test="query != null">
            <where>
                and username like '${query}%'
            </where>
            union
            select * from sys_user_view
            <where>
                and realname like '${query}%'
            </where>
            union
            select * from sys_user_view
            <where>
                and code like '${query}%'
            </where>
        </if>
    </sql>
    <select id="selectNotCadreList" resultMap="persistence.sys.SysUserViewMapper.BaseResultMap" parameterType="map">
        select * from (<include refid="userSearchSql" />) u where id not in(select c.user_id from cadre c
        <if test="cadreStatusList.size>0">
            <where>
            and c.status in
            <foreach collection="cadreStatusList" item="status"
                     index="index" open="(" close=")" separator=",">
                #{status}
            </foreach>
            </where>
        </if>
        )
        and role_ids not like "%${regRoleStr}%"
        order by create_time desc
    </select>

    <select id="countNotCadreList" parameterType="map" resultType="java.lang.Integer">
        select count(id) from (<include refid="userSearchSql" />) u where id not in(select c.user_id from cadre c
        <if test="cadreStatusList.size>0">
            <where>
            and c.status in
            <foreach collection="cadreStatusList" item="status"
                     index="index" open="(" close=")" separator=",">
                #{status}
            </foreach>
            </where>
        </if>
        )
        and role_ids not like "%${regRoleStr}%"
    </select>

    <!--<select id="selectCadreByUnitIdList" resultMap="persistence.cadre.CadreMapper.BaseResultMap" parameterType="map" >
     select c.* from cadre c, sys_user_view user where user.id in(
     select c.user_id from cadre_main_work cmw, cadre c where cmw.unit_id=#{unitId} and cmw.cadre_id = c.id
     union all
     select c.user_id from cadre_sub_work csw, cadre c where csw.unit_id=#{unitId} and csw.cadre_id = c.id)
     <if test="search != null" >
       and (user.username like #{search} or user.realname like #{search} or user.code like #{search})
     </if>
     and c.user_id = user.id
     <if test="cadreStatusList.size>0">
       and  c.status in
       <foreach collection="cadreStatusList" item="status"
                index="index" open="(" close=")" separator=",">
         #{status}
       </foreach>
     </if>
     order by c.sort_order desc
   </select>
   <select id="countCadreByUnitIdList" parameterType="map" resultType="java.lang.Integer" >
     select count(c.id) from cadre c, sys_user_view user where user.id in(
     select c.user_id from cadre_main_work cmw, cadre c where cmw.unit_id=#{unitId} and cmw.cadre_id = c.id
     union all
     select c.user_id from cadre_sub_work csw, cadre c where csw.unit_id=#{unitId} and csw.cadre_id = c.id)
     <if test="search != null" >
       and (user.username like #{search} or user.realname like #{search} or user.code like #{search})
     </if>
     and c.user_id = user.id
     <if test="cadreStatusList.size>0">
       and  c.status in
       <foreach collection="cadreStatusList" item="status"
                index="index" open="(" close=")" separator=",">
         #{status}
       </foreach>
     </if>
   </select>-->

    <select id="getCadreFamilys" resultMap="persistence.cadre.CadreFamilyMapper.BaseResultMap" parameterType="map">
        select cf.* from cadre_family cf, cadre c where cf.cadre_id=c.id
        <if test="cadreIds != null and cadreIds.length>0">
            and c.id IN
            <foreach collection="cadreIds" item="cadreId" separator="," open="(" close=")">
                #{cadreId}
            </foreach>
        </if>
        <if test="status != null">
            and c.status = #{status}
        </if>
        order by c.sort_order desc
    </select>
</mapper>